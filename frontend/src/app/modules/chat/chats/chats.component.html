<div class="bg-card relative flex w-full flex-auto dark:bg-transparent">
    <mat-drawer-container class="h-full flex-auto" [hasBackdrop]="false">
        <!-- Drawer -->
        <mat-drawer class="w-full dark:bg-gray-900 sm:w-100 lg:border-r lg:shadow-none" [autoFocus]="false"
            [(opened)]="drawerOpened" #drawer>
            <!-- New chat -->
            @if (drawerComponent === 'new-chat') {
            <chat-new-chat [drawer]="drawer"></chat-new-chat>
            }
        </mat-drawer>

        <mat-drawer-content class="flex overflow-hidden">
            <!-- Chats list - Always show -->
            <div
                class="bg-card relative flex w-full min-w-0 flex-auto flex-col dark:bg-transparent lg:min-w-100 lg:max-w-100">
                <!-- Header -->
                <div class="flex flex-0 flex-col border-b bg-gray-50 px-8 py-4 dark:bg-transparent">
                    <div class="flex items-center">
                        <div class="mr-1 flex  items-center">
                            <div class="h-10 w-10">
                                @if (profile?.avatar) {
                                    <img class="h-full w-full rounded-full object-cover" [src]="profile.avatar"
                                        alt="Profile avatar" />
                                } @else {
                                    @if (profile?.name) {
                                        <div
                                            class="flex h-full w-full items-center justify-center rounded-full bg-gray-200 text-lg uppercase text-gray-600 dark:bg-gray-700 dark:text-gray-200">
                                            {{ profile.name.charAt(0) }}
                                        </div>
                                    }
                                }
                            </div>
                            <div class="ml-4 truncate font-medium">
                                {{ profile?.name }}
                            </div>
                        </div>
                        <button class="ml-auto" mat-icon-button (click)="openNewChat()">
                            <mat-icon [svgIcon]="'heroicons_outline:plus-circle'"></mat-icon>
                        </button>
                    </div>

                </div>

                <!-- Chats -->
                <div class="flex-auto overflow-y-auto">
                    @if (filteredChats.length > 0) {
                    @for (
                    chat of filteredChats;
                    track trackByFn($index, chat)
                    ) {
                    <a class="z-20 flex cursor-pointer items-center border-b px-8 py-5" [ngClass]="{
                                        'dark:hover:bg-hover hover:bg-gray-100':
                                            !selectedChat ||
                                            selectedChat.id !== chat.id,
                                        'bg-primary-50 dark:bg-hover':
                                            selectedChat &&
                                            selectedChat.id === chat.id,
                                    }" [routerLink]="['chat', chat.id]">
                        <div class="relative flex h-10 w-10 flex-0 items-center justify-center">
                            @if (chat.unreadCount > 0) {
                                <div class="absolute -top-1 -right-1 min-w-[18px] h-5 px-1.5 rounded-full bg-red-600 text-white text-xs font-semibold flex items-center justify-center shadow-sm dark:bg-red-500">
                                    {{ chat.unreadCount > 99 ? '99+' : chat.unreadCount }}
                                </div>
                            }
                            @if (chat.contact?.avatar) {
                                <img class="h-full w-full rounded-full object-cover" [src]="chat.contact.avatar"
                                    alt="Contact avatar" />
                            } @else {
                                @if (chat.contact?.name) {
                                    <div
                                        class="flex h-full w-full items-center justify-center rounded-full bg-gray-200 text-lg uppercase text-gray-600 dark:bg-gray-700 dark:text-gray-200">
                                        {{ chat.contact.name.charAt(0) }}
                                    </div>
                                }
                            }
                        </div>
                        <div class="ml-4 min-w-0">
                            <div class="truncate font-medium leading-5">
                                {{ chat.contact?.name || 'Unknown' }}
                            </div>
                            <div class="text-secondary truncate leading-5">
                                {{ chat.lastMessage }}
                            </div>
                        </div>
                        <div class="ml-auto flex flex-col items-end self-start pl-2">
                            <div class="text-secondary text-sm leading-5">
                                {{ chat.lastMessageAt | date:  "dd/MM/yyyy HH:mm" }}
                            </div>
                            @if (chat.muted) {
                            <mat-icon class="text-hint icon-size-5" [svgIcon]="
                                                    'heroicons_solid:speaker-x-mark'
                                                "></mat-icon>
                            }
                        </div>
                    </a>
                    }
                    } @else {
                    <div class="flex h-full flex-auto flex-col items-center justify-center">
                        <mat-icon class="icon-size-24" [svgIcon]="
                                        'heroicons_outline:chat-bubble-oval-left-ellipsis'
                                    "></mat-icon>
                        <div class="text-secondary mt-4 text-2xl font-semibold tracking-tight">
                            No chats
                        </div>
                    </div>
                    }
                </div>
            </div>

            <!-- Conversation -->
            <div class="flex-auto border-l" [ngClass]="{
                        'absolute inset-0 z-20 flex lg:static lg:inset-auto':
                            selectedChat && selectedChat.id,
                        'hidden lg:flex': !selectedChat || !selectedChat.id,
                    }">
                <router-outlet></router-outlet>
            </div>
        </mat-drawer-content>
    </mat-drawer-container>
</div>
